<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>æ­£ã—ã„ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ å®Ÿè£… + PDF</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow: hidden;
      touch-action: none;
      background: #e0e0e0;
    }

    /* é‡è¦: transformã‚’é©ç”¨ã™ã‚‹è¦ç´ ã¯ç”»é¢å…¨ä½“ã«åºƒã’ã‚‹ */
    .viewport {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }

    /* transform-origin: 0 0 ãŒé‡è¦ */
    .canvas-layer {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0;
      /* åˆæœŸä½ç½®ã¯ç”»é¢ä¸­å¤®ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ç½® */
      transform: translate(calc(50vw - 200px), calc(50vh - 300px));
    }

    .canvas {
      display: block;
      background: white;
      border: 2px solid #333;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆPDFã®ä¸Šã«é‡ã­ã‚‹ï¼‰ */
    .drawing-canvas {
      position: absolute;
      top: 0;
      left: 0;
      cursor: crosshair;
    }

    .info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      z-index: 1000;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      gap: 15px;
    }

    .info-label {
      color: #aaa;
    }

    .info-value {
      color: #0f0;
      font-weight: bold;
    }

    .title {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 50, 50, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      z-index: 1000;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .toolbar {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      align-items: center;
    }

    .toolbar button {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 8px;
      background: #f0f0f0;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .toolbar button:hover {
      background: #e0e0e0;
      transform: scale(1.05);
    }

    .toolbar button:active {
      transform: scale(0.95);
    }

    .toolbar button.active {
      background: #4CAF50;
      color: white;
    }

    .toolbar .divider {
      width: 1px;
      height: 32px;
      background: #ddd;
      margin: 0 4px;
    }
  </style>
</head>
<body>
  <div class="title">æ­£ã—ã„åŸºæœ¬æ§‹é€ </div>

  <div class="info">
    <div class="info-row">
      <span class="info-label">Scale:</span>
      <span class="info-value" id="scale">1.00</span>
    </div>
    <div class="info-row">
      <span class="info-label">OriginX:</span>
      <span class="info-value" id="ox">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">OriginY:</span>
      <span class="info-value" id="oy">-</span>
    </div>
    <div class="info-row">
      <span class="info-label">Touches:</span>
      <span class="info-value" id="touches">0</span>
    </div>
  </div>

  <div class="viewport" id="viewport">
    <div class="canvas-layer" id="layer">
      <canvas id="canvas" class="canvas"></canvas>
      <canvas id="drawing-canvas" class="drawing-canvas"></canvas>
    </div>
  </div>

  <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div class="toolbar">
    <button id="pen-btn" class="active" title="ãƒšãƒ³ãƒ¢ãƒ¼ãƒ‰">âœï¸</button>
    <button id="color-btn" title="è‰²é¸æŠ">ğŸ¨</button>
    <div class="divider"></div>
    <button id="eraser-btn" title="æ¶ˆã—ã‚´ãƒ ">ğŸ§¹</button>
    <div class="divider"></div>
    <button id="grade-btn" title="æ¡ç‚¹">âœ…</button>
    <div class="divider"></div>
    <button id="undo-btn" title="å…ƒã«æˆ»ã™">â†©ï¸</button>
    <button id="clear-btn" title="ã‚¯ãƒªã‚¢">ğŸ—‘ï¸</button>
    <div class="divider"></div>
    <button id="debug-btn" title="ãƒ‡ãƒãƒƒã‚°">ğŸ¯</button>
  </div>

  <script>
    // PDF.js setup
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'

    const viewport = document.getElementById('viewport')
    const layer = document.getElementById('layer')
    const canvas = document.getElementById('canvas')
    const ctx = canvas.getContext('2d')
    const drawingCanvas = document.getElementById('drawing-canvas')
    const drawingCtx = drawingCanvas.getContext('2d')

    // PDFã®åŸºæœ¬ã‚µã‚¤ã‚ºï¼ˆç”»é¢è¡¨ç¤ºæ™‚ï¼‰
    const BASE_WIDTH = 600
    const BASE_HEIGHT = 800
    
    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å€ç‡ï¼ˆé«˜è§£åƒåº¦åŒ–ï¼‰
    const RENDER_SCALE = 3.0
    const CANVAS_WIDTH = BASE_WIDTH * RENDER_SCALE
    const CANVAS_HEIGHT = BASE_HEIGHT * RENDER_SCALE

    // ã‚µãƒ³ãƒ—ãƒ«PDFã®Base64ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€å°é™ã®PDFï¼‰
    const SAMPLE_PDF_BASE64 = 'JVBERi0xLjQKJeLjz9MKMSAwIG9iago8PC9UeXBlL0NhdGFsb2cvUGFnZXMgMiAwIFI+PgplbmRvYmoKMiAwIG9iago8PC9UeXBlL1BhZ2VzL0tpZHNbMyAwIFJdL0NvdW50IDE+PgplbmRvYmoKMyAwIG9iago8PC9UeXBlL1BhZ2UvTWVkaWFCb3hbMCAwIDYxMiA3OTJdL1BhcmVudCAyIDAgUi9SZXNvdXJjZXM8PC9Gb250PDwvRjEgNCAwIFI+Pj4+L0NvbnRlbnRzIDUgMCBSPj4KZW5kb2JqCjQgMCBvYmoKPDwvVHlwZS9Gb250L1N1YnR5cGUvVHlwZTEvQmFzZUZvbnQvSGVsdmV0aWNhPj4KZW5kb2JqCjUgMCBvYmoKPDwvTGVuZ3RoIDQ0Pj4Kc3RyZWFtCkJUCi9GMSAyNCBUZgo1MCA3MDAgVGQKKEhlbGxvIFBERiEpIFRqCkVUCmVuZHN0cmVhbQplbmRvYmoKeHJlZgowIDYKMDAwMDAwMDAwMCA2NTUzNSBmIAowMDAwMDAwMDE1IDAwMDAwIG4gCjAwMDAwMDAwNjQgMDAwMDAgbiAKMDAwMDAwMDEyMSAwMDAwMCBuIAowMDAwMDAwMjQ3IDAwMDAwIG4gCjAwMDAwMDAzMjQgMDAwMDAgbiAKdHJhaWxlcgo8PC9TaXplIDYvUm9vdCAxIDAgUj4+CnN0YXJ0eHJlZgo0MTgKJSVFT0YK'

    let pdfDoc = null
    let currentPage = null

    // PDF.jsã§PDFã‚’æç”»ã™ã‚‹é–¢æ•°ï¼ˆ3å€ã‚µã‚¤ã‚ºã§é«˜è§£åƒåº¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼‰
    async function renderPDFContent() {
      try {
        if (!pdfDoc) {
          // Base64ã‹ã‚‰PDFã‚’èª­ã¿è¾¼ã¿
          const pdfData = atob(SAMPLE_PDF_BASE64)
          const uint8Array = new Uint8Array(pdfData.length)
          for (let i = 0; i < pdfData.length; i++) {
            uint8Array[i] = pdfData.charCodeAt(i)
          }
          
          const loadingTask = pdfjsLib.getDocument({ data: uint8Array })
          pdfDoc = await loadingTask.promise
          console.log('âœ… PDF loaded:', pdfDoc.numPages, 'pages')
        }
        
        // 1ãƒšãƒ¼ã‚¸ç›®ã‚’å–å¾—
        currentPage = await pdfDoc.getPage(1)
        
        // 3å€ã‚¹ã‚±ãƒ¼ãƒ«ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚’å–å¾—
        const viewport = currentPage.getViewport({ scale: RENDER_SCALE })
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’è¨­å®š
        canvas.width = viewport.width
        canvas.height = viewport.height
        
        // æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºå¤‰æ›´å‰ã«å†…å®¹ã‚’ä¿å­˜
        const oldDrawingData = drawingCtx.getImageData(0, 0, drawingCanvas.width, drawingCanvas.height)
        const oldWidth = drawingCanvas.width
        const oldHeight = drawingCanvas.height
        
        // æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚‚åŒã˜ã‚µã‚¤ã‚ºã«
        drawingCanvas.width = viewport.width
        drawingCanvas.height = viewport.height
        
        // æç”»å†…å®¹ã‚’å¾©å…ƒï¼ˆã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ã¦ã‚‚æç”»ã‚’ç¶­æŒï¼‰
        if (oldWidth > 0 && oldHeight > 0) {
          // ä¸€æ™‚ã‚­ãƒ£ãƒ³ãƒã‚¹ã«å¤ã„æç”»ã‚’é…ç½®
          const tempCanvas = document.createElement('canvas')
          tempCanvas.width = oldWidth
          tempCanvas.height = oldHeight
          const tempCtx = tempCanvas.getContext('2d')
          tempCtx.putImageData(oldDrawingData, 0, 0)
          
          // æ–°ã—ã„ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ã—ã¦æç”»
          drawingCtx.drawImage(tempCanvas, 0, 0, oldWidth, oldHeight, 0, 0, viewport.width, viewport.height)
        }
        
        // PDFãƒšãƒ¼ã‚¸ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const renderContext = {
          canvasContext: ctx,
          viewport: viewport
        }
        
        await currentPage.render(renderContext).promise
        console.log('âœ… PDF rendered at', viewport.width, 'x', viewport.height)
      } catch (error) {
        console.error('PDF render error:', error)
        throw error
      }
    }

    // åˆæœŸæç”»
    async function createSamplePDF() {
      await renderPDFContent()
      
      // åˆæœŸãƒ†ã‚¹ãƒˆæç”»ï¼ˆèµ¤ã„Ã—ãƒãƒ¼ã‚¯ã¨é’ã„ä¸¸ï¼‰- 3å€ã‚¹ã‚±ãƒ¼ãƒ«ã§æç”»
      drawingCtx.save()
      drawingCtx.scale(RENDER_SCALE, RENDER_SCALE)
      drawingCtx.strokeStyle = 'red'
      drawingCtx.lineWidth = 3
      drawingCtx.beginPath()
      drawingCtx.moveTo(100, 150)
      drawingCtx.lineTo(150, 200)
      drawingCtx.moveTo(150, 150)
      drawingCtx.lineTo(100, 200)
      drawingCtx.stroke()
      
      // é’ã„ä¸¸
      drawingCtx.strokeStyle = 'blue'
      drawingCtx.lineWidth = 3
      drawingCtx.beginPath()
      drawingCtx.arc(120, 400, 30, 0, Math.PI * 2)
      drawingCtx.stroke()
      drawingCtx.restore()
      
      console.log('âœ… Sample PDF created (3x):', canvas.width, 'x', canvas.height)
      console.log('âœ… Drawing layer added with test marks')
      
      // åˆæœŸã‚¹ã‚±ãƒ¼ãƒ«ã‚’ 1/3 ã«è¨­å®šï¼ˆ3å€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ç­‰å€è¡¨ç¤ºï¼‰
      scale = 1.0 / RENDER_SCALE
      
      // åˆæœŸä½ç½®ã‚’ç”»é¢ä¸­å¤®ã«è¨­å®šï¼ˆå®Ÿéš›ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã§è¨ˆç®—ï¼‰
      const displayWidth = canvas.width * scale
      const displayHeight = canvas.height * scale
      originX = window.innerWidth / 2 - displayWidth / 2
      originY = window.innerHeight / 2 - displayHeight / 2
      applyTransform()
    }

    // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°ï¼ˆæ“ä½œçµ‚äº†å¾Œã«å‘¼ã°ã‚Œã‚‹ï¼‰
    async function rerenderAtCurrentScale() {
      console.log('ğŸ”„ Re-rendering at scale:', scale.toFixed(2))
      
      // å˜ç´”ã«å†æç”»ï¼ˆåº§æ¨™ã¯ãã®ã¾ã¾ã€scaleã‚‚ãã®ã¾ã¾ï¼‰
      await renderPDFContent()
      
      // transform ã‚’å†é©ç”¨ï¼ˆåº§æ¨™ã‚‚ã‚¹ã‚±ãƒ¼ãƒ«ã‚‚å¤‰ã‚ã‚‰ãªã„ï¼‰
      applyTransform()
    }

    // å¤‰æ›ã®çŠ¶æ…‹ï¼ˆåˆæœŸå€¤ã¯ 1/3 = 0.333...ï¼‰
    let scale = 1.0 / 3.0
    let originX = 0
    let originY = 0

    // æç”»ã®çŠ¶æ…‹
    let isDrawingMode = true
    let isDrawing = false
    let penColor = '#FF0000'
    let lastX = 0
    let lastY = 0

    // ãƒ”ãƒ³ãƒçŠ¶æ…‹
    let initialDistance = null
    let initialScale = null
    let initialOriginX = null
    let initialOriginY = null
    let pinchCenterX = null
    let pinchCenterY = null

    function applyTransform() {
      layer.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`
      
      document.getElementById('scale').textContent = scale.toFixed(3)
      document.getElementById('ox').textContent = Math.round(originX)
      document.getElementById('oy').textContent = Math.round(originY)
    }

    function getDistance(t1, t2) {
      const dx = t1.clientX - t2.clientX
      const dy = t1.clientY - t2.clientY
      return Math.sqrt(dx * dx + dy * dy)
    }

    // æç”»åº§æ¨™å¤‰æ›: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ â†’ ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™
    function screenToCanvas(screenX, screenY) {
      // layer ã® transform ã‚’è€ƒæ…®
      const canvasX = (screenX - originX) / scale
      const canvasY = (screenY - originY) / scale
      return { x: canvasX, y: canvasY }
    }

    // ãƒšãƒ³æç”»
    function startDrawing(e) {
      if (!isDrawingMode) return
      
      isDrawing = true
      const { x, y } = screenToCanvas(e.clientX, e.clientY)
      lastX = x
      lastY = y
    }

    function draw(e) {
      if (!isDrawing || !isDrawingMode) return
      
      const { x, y } = screenToCanvas(e.clientX, e.clientY)
      
      drawingCtx.strokeStyle = penColor
      drawingCtx.lineWidth = 3
      drawingCtx.lineCap = 'round'
      drawingCtx.lineJoin = 'round'
      
      drawingCtx.beginPath()
      drawingCtx.moveTo(lastX, lastY)
      drawingCtx.lineTo(x, y)
      drawingCtx.stroke()
      
      lastX = x
      lastY = y
    }

    function stopDrawing() {
      isDrawing = false
    }

    // ã‚¿ãƒƒãƒæç”»ï¼ˆãƒ‘ãƒ¼ãƒ ãƒªã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
    function handleDrawingTouchStart(e) {
      if (!isDrawingMode || e.touches.length !== 1) return
      
      const touch = e.touches[0]
      
      // ãƒ‘ãƒ¼ãƒ ãƒªã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³: ãƒšãƒ³/ã‚¹ã‚¿ã‚¤ãƒ©ã‚¹ã®ã¿å—ã‘ä»˜ã‘ã‚‹
      // touchType: 'stylus' = Apple Pencilç­‰, 'direct' = æŒ‡
      if (touch.touchType === 'direct') {
        console.log('âŒ Palm rejected: direct touch (finger)')
        return
      }
      
      e.preventDefault()
      const { x, y } = screenToCanvas(touch.clientX, touch.clientY)
      
      isDrawing = true
      lastX = x
      lastY = y
      console.log('âœï¸ Drawing started with stylus')
    }

    function handleDrawingTouchMove(e) {
      if (!isDrawing || !isDrawingMode || e.touches.length !== 1) return
      
      const touch = e.touches[0]
      
      // ãƒ‘ãƒ¼ãƒ ãƒªã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³: æç”»ä¸­ã‚‚ãƒšãƒ³/ã‚¹ã‚¿ã‚¤ãƒ©ã‚¹ã®ã¿
      if (touch.touchType === 'direct') {
        return
      }
      
      e.preventDefault()
      const { x, y } = screenToCanvas(touch.clientX, touch.clientY)
      
      drawingCtx.strokeStyle = penColor
      drawingCtx.lineWidth = 3
      drawingCtx.lineCap = 'round'
      drawingCtx.lineJoin = 'round'
      
      drawingCtx.beginPath()
      drawingCtx.moveTo(lastX, lastY)
      drawingCtx.lineTo(x, y)
      drawingCtx.stroke()
      
      lastX = x
      lastY = y
    }

    function handleDrawingTouchEnd(e) {
      isDrawing = false
    }

    // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('pen-btn').addEventListener('click', () => {
      isDrawingMode = true
      document.getElementById('pen-btn').classList.add('active')
    })

    document.getElementById('clear-btn').addEventListener('click', () => {
      drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height)
    })

    // æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    drawingCanvas.addEventListener('mousedown', startDrawing)
    drawingCanvas.addEventListener('mousemove', draw)
    drawingCanvas.addEventListener('mouseup', stopDrawing)
    drawingCanvas.addEventListener('mouseleave', stopDrawing)
    drawingCanvas.addEventListener('touchstart', handleDrawingTouchStart, { passive: false })
    drawingCanvas.addEventListener('touchmove', handleDrawingTouchMove, { passive: false })
    drawingCanvas.addEventListener('touchend', handleDrawingTouchEnd, { passive: false })

    // ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆviewport ã«è¨­å®šï¼‰
    viewport.addEventListener('touchstart', (e) => {
      document.getElementById('touches').textContent = e.touches.length

      if (e.touches.length === 2) {
        e.preventDefault()
        
        const t1 = e.touches[0]
        const t2 = e.touches[1]
        
        // åˆæœŸå€¤ã‚’ä¿å­˜
        initialDistance = getDistance(t1, t2)
        initialScale = scale
        initialOriginX = originX
        initialOriginY = originY
        
        // ãƒ”ãƒ³ãƒã®ä¸­å¿ƒç‚¹ï¼ˆãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆåº§æ¨™ï¼‰
        pinchCenterX = (t1.clientX + t2.clientX) / 2
        pinchCenterY = (t1.clientY + t2.clientY) / 2
      }
    }, { passive: false })

    viewport.addEventListener('touchmove', (e) => {
      document.getElementById('touches').textContent = e.touches.length

      if (e.touches.length === 2 && initialDistance !== null) {
        e.preventDefault()
        
        const t1 = e.touches[0]
        const t2 = e.touches[1]
        
        // ç¾åœ¨ã®è·é›¢
        const currentDistance = getDistance(t1, t2)
        
        // ã‚¹ã‚±ãƒ¼ãƒ«æ¯”ç‡ï¼ˆæœ€å° 1/3 = 0.33ã€æœ€å¤§ 1.0 = ç­‰å€ï¼‰
        const ratio = currentDistance / initialDistance
        scale = Math.max(1.0 / RENDER_SCALE, Math.min(1.0, initialScale * ratio))
        
        // ç¾åœ¨ã®æŒ‡ã®ä¸­å¿ƒä½ç½®ï¼ˆãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆåº§æ¨™ï¼‰
        const currentPinchCenterX = (t1.clientX + t2.clientX) / 2
        const currentPinchCenterY = (t1.clientY + t2.clientY) / 2
        
        // ãƒ”ãƒ³ãƒé–‹å§‹æ™‚ã®æŒ‡ã®ä¸­å¿ƒã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—
        // å…¬å¼: newOrigin = pinchCenter - (pinchCenter - initialOrigin) * (newScale / initialScale)
        originX = pinchCenterX - (pinchCenterX - initialOriginX) * (scale / initialScale)
        originY = pinchCenterY - (pinchCenterY - initialOriginY) * (scale / initialScale)
        
        // æŒ‡ã®ç§»å‹•ã«ã‚ˆã‚‹ãƒ‘ãƒ³
        originX += currentPinchCenterX - pinchCenterX
        originY += currentPinchCenterY - pinchCenterY
        
        applyTransform()
      }
    }, { passive: false })

    viewport.addEventListener('touchend', (e) => {
      document.getElementById('touches').textContent = e.touches.length

      if (e.touches.length < 2) {
        // ãƒ”ãƒ³ãƒæ“ä½œãŒçµ‚äº†ã—ãŸã‚‰å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        if (initialDistance !== null) {
          console.log('ğŸ”„ Pinch ended, re-rendering at scale:', scale.toFixed(2))
          rerenderAtCurrentScale()
        }
        
        initialDistance = null
        initialScale = null
        initialOriginX = null
        initialOriginY = null
        pinchCenterX = null
        pinchCenterY = null
      }
    }, { passive: false })

    // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã®ã‚ºãƒ¼ãƒ ï¼ˆCtrl+ãƒ›ã‚¤ãƒ¼ãƒ«ï¼‰
    viewport.addEventListener('wheel', (e) => {
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault()
        
        // ãƒã‚¦ã‚¹ä½ç½®ï¼ˆãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆåº§æ¨™ï¼‰
        const mouseX = e.clientX
        const mouseY = e.clientY
        
        // ã‚ºãƒ¼ãƒ é‡ï¼ˆæœ€å° 1/3ã€æœ€å¤§ 1.0ï¼‰
        const delta = -e.deltaY * 0.002
        const oldScale = scale
        scale = Math.max(1.0 / RENDER_SCALE, Math.min(1.0, scale * (1 + delta)))
        
        // ãƒã‚¦ã‚¹ä½ç½®ã‚’ä¸­å¿ƒã«ã‚ºãƒ¼ãƒ 
        // å…¬å¼: newOrigin = mousePos - (mousePos - oldOrigin) * (newScale / oldScale)
        originX = mouseX - (mouseX - originX) * (scale / oldScale)
        originY = mouseY - (mouseY - originY) * (scale / oldScale)
        
        applyTransform()
      }
    }, { passive: false })

    // ã‚µãƒ³ãƒ—ãƒ«PDFã‚’è¡¨ç¤º
    createSamplePDF().catch(err => {
      console.error('PDF render error:', err)
    })
    
    console.log('âœ… æ­£ã—ã„åŸºæœ¬æ§‹é€ ã®ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ  + PDF.js')
    console.log('ğŸ“ transform-origin: 0 0')
    console.log('ğŸ“± touchstartã§åˆæœŸå€¤ä¿å­˜ â†’ touchmoveã§åˆæœŸå€¤ã‹ã‚‰è¨ˆç®—')
    console.log('ğŸ¨ 3å€ãƒ—ãƒªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æˆ¦ç•¥')
  </script>
</body>
</html>
